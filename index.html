<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Performance Tracker</title>
  <link rel="alternate" type="application/rss+xml" title="Claude Code Performance RSS" href="feed.xml">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; background: #0d1117; color: #c9d1d9; padding: 0.75rem; font-size: 13px; }
    a { color: #fb923c; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */
    .header { display: flex; align-items: baseline; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
    .header h1 { color: #fb923c; font-size: 1.1rem; white-space: nowrap; }
    .header .links { font-size: 0.75rem; color: #8b949e; display: flex; gap: 0.75rem; }

    /* Status bar */
    .status-bar { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.75rem; border: 1px solid #30363d; background: #161b22; }
    .status-bar.loading { border-color: #fb923c; }
    .status-bar.success { border-color: #3fb950; }
    .status-bar.error { border-color: #f85149; }
    .status-bar .dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .status-bar.loading .dot { background: #fb923c; }
    .status-bar.success .dot { background: #3fb950; }
    .status-bar.error .dot { background: #f85149; }

    /* Metrics row */
    .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 0.5rem; }
    .metric { background: #161b22; border: 1px solid #30363d; border-radius: 4px; padding: 0.4rem 0.5rem; text-align: center; }
    .metric .value { font-size: 1.2rem; font-weight: 700; color: #fb923c; line-height: 1.2; }
    .metric .label { font-size: 0.65rem; color: #8b949e; }

    /* Two-column layout */
    .columns { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; }
    @media (max-width: 800px) { .columns { grid-template-columns: 1fr; } .metrics { grid-template-columns: repeat(2, 1fr); } }

    /* Panel */
    .panel { background: #161b22; border: 1px solid #30363d; border-radius: 4px; overflow: hidden; }
    .panel-head { padding: 0.35rem 0.5rem; font-size: 0.7rem; font-weight: 600; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #30363d; background: #0d1117; }

    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    th { text-align: left; padding: 0.25rem 0.4rem; color: #8b949e; font-weight: 600; font-size: 0.7rem; border-bottom: 1px solid #30363d; background: #0d1117; position: sticky; top: 0; }
    td { padding: 0.2rem 0.4rem; border-bottom: 1px solid #21262d; white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #1c2128; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .change-neg { color: #f85149; }
    .change-pos { color: #3fb950; }
    .change-neutral { color: #8b949e; }
    .rate { font-weight: 600; color: #fb923c; }

    /* Scrollable table body */
    .table-wrap { max-height: calc(100vh - 220px); overflow-y: auto; }
    .table-wrap::-webkit-scrollbar { width: 4px; }
    .table-wrap::-webkit-scrollbar-thumb { background: #30363d; border-radius: 2px; }

    /* Actions */
    .actions { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    button { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; padding: 0.25rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.72rem; font-family: inherit; }
    button:hover { background: #30363d; border-color: #8b949e; }
    button.primary { background: #fb923c; color: #0d1117; border-color: #fb923c; font-weight: 600; }
    button.primary:hover { background: #f97316; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* XML preview */
    pre { background: #161b22; border: 1px solid #30363d; border-radius: 4px; padding: 0.5rem; overflow: auto; font-size: 0.72rem; max-height: 300px; display: none; margin-top: 0.5rem; }
    pre.visible { display: block; }

    footer { color: #484f58; font-size: 0.65rem; padding-top: 0.4rem; border-top: 1px solid #21262d; margin-top: 0.5rem; }
  </style>
</head>
<body>

  <div class="header">
    <h1>Claude Code Perf Tracker</h1>
    <div class="links">
      <a href="https://marginlab.ai/trackers/claude-code/" target="_blank">Source</a>
      <a href="feed.xml">RSS Feed</a>
    </div>
  </div>

  <div id="status" class="status-bar loading"><span class="dot"></span><span>Fetching data...</span></div>

  <div class="metrics" id="metrics" style="display:none;"></div>

  <div class="columns">
    <div class="panel">
      <div class="panel-head">Daily Results</div>
      <div class="table-wrap" id="daily-wrap">
        <table><thead><tr>
          <th>Date</th><th class="num">Rate</th><th class="num">CI</th><th class="num">Runs</th><th class="num">Pass</th><th class="num">vs Base</th>
        </tr></thead><tbody id="daily-body"></tbody></table>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">Weekly Aggregates</div>
      <div class="table-wrap" id="weekly-wrap">
        <table><thead><tr>
          <th>Period</th><th class="num">Rate</th><th class="num">CI</th><th class="num">Runs</th>
        </tr></thead><tbody id="weekly-body"></tbody></table>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="primary" id="btn-rss" disabled onclick="downloadRSS()">RSS</button>
    <button id="btn-json" disabled onclick="downloadJSON()">JSON</button>
    <button id="btn-toggle" disabled onclick="toggleXML()">XML</button>
    <button id="btn-refresh" onclick="fetchData()">Refresh</button>
  </div>

  <pre id="xml-output"></pre>

  <footer>Data from <a href="https://marginlab.ai" target="_blank">MarginLab</a>. Client-side only.</footer>

  <script>
    let rssXML = '', jsonData = null;

    function r(v) { return Math.round(v * 100) / 100; }
    function changeHTML(val) {
      if (val === null) return '<span class="change-neutral">--</span>';
      const v = parseFloat(val);
      const cls = v > 0 ? 'change-pos' : v < 0 ? 'change-neg' : 'change-neutral';
      return `<span class="${cls}">${v >= 0 ? '+' : ''}${val}%</span>`;
    }

    function renderMetrics(data) {
      const el = document.getElementById('metrics');
      const { daily, baseline } = data;
      if (!daily || !daily.length) return;
      const sorted = [...daily].sort((a, b) => b.date.localeCompare(a.date));
      const latest = sorted[0];
      const avg7 = sorted.slice(0, 7).reduce((s, e) => s + e.passRate, 0) / Math.min(7, sorted.length);
      const avgAll = sorted.reduce((s, e) => s + e.passRate, 0) / sorted.length;
      const bl = baseline ? Math.round(baseline) : null;
      const ch = bl !== null ? (r(avgAll) - bl).toFixed(1) : null;
      const chCls = ch !== null ? (ch > 0 ? 'change-pos' : ch < 0 ? 'change-neg' : 'change-neutral') : '';
      el.innerHTML = `
        <div class="metric"><div class="value">${r(latest.passRate)}%</div><div class="label">Latest ${latest.date}</div></div>
        <div class="metric"><div class="value">${r(avg7).toFixed(1)}%</div><div class="label">7-day avg</div></div>
        <div class="metric"><div class="value">${r(avgAll).toFixed(1)}%</div><div class="label">30-day avg</div></div>
        <div class="metric"><div class="value ${chCls}">${ch !== null ? (ch >= 0 ? '+' : '') + ch + '%' : '--'}</div><div class="label">vs baseline ${bl ?? '?'}%</div></div>`;
      el.style.display = '';
    }

    function renderDaily(data) {
      const { daily, baseline } = data;
      const el = document.getElementById('daily-body');
      if (!daily) { el.innerHTML = '<tr><td colspan="6">No data</td></tr>'; return; }
      const bl = baseline ? Math.round(baseline) : null;
      const sorted = [...daily].sort((a, b) => b.date.localeCompare(a.date));
      el.innerHTML = sorted.map(e => {
        const ch = bl !== null ? (r(e.passRate) - bl).toFixed(1) : null;
        return `<tr>
          <td>${e.date.slice(5)}</td>
          <td class="num rate">${r(e.passRate)}%</td>
          <td class="num">${e.ciLower?.toFixed(1)}–${e.ciUpper?.toFixed(1)}</td>
          <td class="num">${e.runsCount}</td>
          <td class="num">${e.passed}</td>
          <td class="num">${changeHTML(ch)}</td>
        </tr>`;
      }).join('');
    }

    function renderWeekly(data) {
      const { weekly } = data;
      const el = document.getElementById('weekly-body');
      if (!weekly || !weekly.length) { el.innerHTML = '<tr><td colspan="4">No data</td></tr>'; return; }
      const sorted = [...weekly].sort((a, b) => b.startDate.localeCompare(a.startDate));
      el.innerHTML = sorted.map(e => `<tr>
        <td>${e.dateRange}</td>
        <td class="num rate">${r(e.passRate)}%</td>
        <td class="num">${e.ciLower?.toFixed(1)}–${e.ciUpper?.toFixed(1)}</td>
        <td class="num">${e.runsCount}</td>
      </tr>`).join('');
    }

    async function fetchData() {
      const s = document.getElementById('status');
      s.className = 'status-bar loading'; s.innerHTML = '<span class="dot"></span><span>Loading...</span>';
      ['btn-rss','btn-json','btn-toggle'].forEach(id => document.getElementById(id).disabled = true);
      try {
        const [dataResp, rssResp] = await Promise.all([
          fetch('data.json'),
          fetch('feed.xml')
        ]);
        if (!dataResp.ok) throw new Error('data.json not found. Run the GitHub Action first.');
        const data = await dataResp.json();
        rssXML = rssResp.ok ? await rssResp.text() : '';
        if (!data.daily || !data.daily.length) throw new Error('No daily data in data.json.');
        jsonData = data;
        renderMetrics(data);
        renderDaily(data);
        renderWeekly(data);
        if (rssXML) document.getElementById('xml-output').textContent = rssXML;
        ['btn-rss','btn-json','btn-toggle'].forEach(id => document.getElementById(id).disabled = false);
        s.className = 'status-bar success';
        s.innerHTML = `<span class="dot"></span><span>${data.daily.length} daily + ${data.weekly?.length||0} weekly &middot; updated by GitHub Action</span>`;
      } catch (err) {
        s.className = 'status-bar error';
        s.innerHTML = `<span class="dot"></span><span>${err.message}</span>`;
      }
    }

    function downloadRSS() { if (!rssXML) return; const b = new Blob([rssXML],{type:'application/rss+xml'}); const u = URL.createObjectURL(b); Object.assign(document.createElement('a'),{href:u,download:'claude-code.rss'}).click(); URL.revokeObjectURL(u); }
    function downloadJSON() { if (!jsonData) return; const b = new Blob([JSON.stringify(jsonData,null,2)],{type:'application/json'}); const u = URL.createObjectURL(b); Object.assign(document.createElement('a'),{href:u,download:'claude-code.json'}).click(); URL.revokeObjectURL(u); }
    function toggleXML() { const p = document.getElementById('xml-output'); p.classList.toggle('visible'); document.getElementById('btn-toggle').textContent = p.classList.contains('visible') ? 'Hide XML' : 'XML'; }

    fetchData();
  </script>
</body>
</html>
