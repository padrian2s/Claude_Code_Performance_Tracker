<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Performance Tracker - RSS Feed</title>
  <link rel="alternate" type="application/rss+xml" title="Claude Code Performance RSS" href="feed.xml">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; background: #0d1117; color: #c9d1d9; padding: 2rem; }
    h1 { color: #fb923c; margin-bottom: 0.5rem; font-size: 1.5rem; }
    .subtitle { color: #8b949e; margin-bottom: 2rem; font-size: 0.9rem; }
    .subtitle a { color: #fb923c; text-decoration: none; }
    .subtitle a:hover { text-decoration: underline; }
    .status { padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border: 1px solid #30363d; background: #161b22; }
    .status.loading { border-color: #fb923c; }
    .status.success { border-color: #3fb950; }
    .status.error { border-color: #f85149; }
    .actions { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
    button { background: #fb923c; color: #0d1117; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
    button:hover { background: #f97316; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .rss-url { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 0.8rem 1rem; font-family: monospace; font-size: 0.85rem; color: #c9d1d9; word-break: break-all; margin-bottom: 1.5rem; }
    .feed-items { list-style: none; }
    .feed-item { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; }
    .feed-item h3 { color: #fb923c; font-size: 0.95rem; margin-bottom: 0.4rem; }
    .feed-item .date { color: #8b949e; font-size: 0.8rem; margin-bottom: 0.5rem; }
    .feed-item .desc { color: #c9d1d9; font-size: 0.85rem; line-height: 1.5; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin-bottom: 2rem; }
    .metric { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 1rem; text-align: center; }
    .metric .value { font-size: 1.8rem; font-weight: 700; color: #fb923c; }
    .metric .label { font-size: 0.75rem; color: #8b949e; margin-top: 0.25rem; }
    .change-neg { color: #f85149 !important; }
    .change-pos { color: #3fb950 !important; }
    .change-neutral { color: #8b949e !important; }
    pre { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 1rem; overflow-x: auto; font-size: 0.8rem; max-height: 400px; overflow-y: auto; display: none; margin-top: 1rem; }
    pre.visible { display: block; }
    footer { margin-top: 3rem; color: #484f58; font-size: 0.75rem; border-top: 1px solid #21262d; padding-top: 1rem; }
  </style>
</head>
<body>

  <h1>Claude Code Performance Tracker</h1>
  <p class="subtitle">RSS feed generated from <a href="https://marginlab.ai/trackers/claude-code/" target="_blank">marginlab.ai/trackers/claude-code</a></p>
  <div class="rss-url">RSS endpoint: <a href="feed.xml" style="color:#fb923c;">feed.xml</a> — subscribe with any RSS reader</div>

  <div id="status" class="status loading">Fetching latest data...</div>

  <div class="metrics" id="metrics" style="display:none;"></div>

  <div class="actions">
    <button id="btn-rss" disabled onclick="downloadRSS()">Download RSS (XML)</button>
    <button id="btn-json" disabled onclick="downloadJSON()">Download JSON</button>
    <button id="btn-toggle" disabled onclick="toggleXML()">Show Raw XML</button>
    <button id="btn-refresh" onclick="fetchData()">Refresh</button>
  </div>

  <pre id="xml-output"></pre>

  <ul class="feed-items" id="feed-items"></ul>

  <footer>
    Data sourced from MarginLab. This page runs entirely client-side — no server required.
  </footer>

  <script>
    const SOURCE_URL = 'https://marginlab.ai/trackers/claude-code/';
    const CORS_PROXIES = [
      url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    ];

    let rssXML = '';
    let jsonData = null;

    async function fetchWithProxy(url) {
      for (const makeProxy of CORS_PROXIES) {
        try {
          const proxyUrl = makeProxy(url);
          const resp = await fetch(proxyUrl);
          if (resp.ok) return await resp.text();
        } catch (e) {
          continue;
        }
      }
      throw new Error('All CORS proxies failed. Try again later.');
    }

    function extractJSON(html, varPattern) {
      const regex = new RegExp(varPattern + '\\s*=\\s*(\\[\\s*\\{[\\s\\S]*?\\}\\s*\\]);', 'm');
      const match = html.match(regex);
      if (match) {
        try { return JSON.parse(match[1]); } catch (e) { return null; }
      }
      return null;
    }

    function extractAllData(html) {
      // Extract daily data array - look for array of objects with passRate and date
      const dailyPattern = /(\[\s*\{\s*"date"\s*:\s*"20[\s\S]*?\}\s*\])/g;
      const weeklyPattern = /(\[\s*\{\s*"startDate"\s*:\s*"20[\s\S]*?\}\s*\])/g;

      let daily = null, weekly = null;

      // Find all JSON arrays in script tags
      const scriptBlocks = html.match(/<script[^>]*>([\s\S]*?)<\/script>/gi) || [];
      for (const block of scriptBlocks) {
        const content = block.replace(/<\/?script[^>]*>/gi, '');

        // Daily data: has "date" and "passRate"
        const dailyMatches = [...content.matchAll(/(\[\s*\{[^[\]]*"date"\s*:[^[\]]*"passRate"\s*:[^[\]]*\}\s*\])/g)];
        for (const m of dailyMatches) {
          try {
            const parsed = JSON.parse(m[1]);
            if (parsed.length > 0 && parsed[0].date && parsed[0].passRate !== undefined) {
              if (!daily || parsed.length > daily.length) daily = parsed;
            }
          } catch (e) {}
        }

        // Weekly data: has "startDate" and "passRate"
        const weeklyMatches = [...content.matchAll(/(\[\s*\{[^[\]]*"startDate"\s*:[^[\]]*"passRate"\s*:[^[\]]*\}\s*\])/g)];
        for (const m of weeklyMatches) {
          try {
            const parsed = JSON.parse(m[1]);
            if (parsed.length > 0 && parsed[0].startDate) {
              if (!weekly || parsed.length > weekly.length) weekly = parsed;
            }
          } catch (e) {}
        }
      }

      // Fallback: scan entire HTML for JSON arrays
      if (!daily) {
        const allArrays = [...html.matchAll(/(\[\s*\{\s*"date"\s*:\s*"20\d{2}-\d{2}-\d{2}"[^[\]]*\}\s*(?:,\s*\{[^[\]]*\}\s*)*\])/g)];
        for (const m of allArrays) {
          try {
            const parsed = JSON.parse(m[1]);
            if (parsed.length > 0 && parsed[0].passRate !== undefined) {
              if (!daily || parsed.length > daily.length) daily = parsed;
            }
          } catch (e) {}
        }
      }

      if (!weekly) {
        const allArrays = [...html.matchAll(/(\[\s*\{\s*"startDate"\s*:\s*"20\d{2}-\d{2}-\d{2}"[^[\]]*\}\s*(?:,\s*\{[^[\]]*\}\s*)*\])/g)];
        for (const m of allArrays) {
          try {
            const parsed = JSON.parse(m[1]);
            if (parsed.length > 0 && parsed[0].passRate !== undefined) {
              if (!weekly || parsed.length > weekly.length) weekly = parsed;
            }
          } catch (e) {}
        }
      }

      // Extract baseline
      let baseline = null;
      const baselineMatch = html.match(/baseline[^=]*=\s*([\d.]+)/i) ||
                            html.match(/baselinePassRate[^=]*=\s*([\d.]+)/i) ||
                            html.match(/"baseline"\s*:\s*([\d.]+)/i);
      if (baselineMatch) baseline = parseFloat(baselineMatch[1]);

      return { daily, weekly, baseline };
    }

    function escapeXML(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function buildRSS(data) {
      const { daily, weekly, baseline } = data;
      const now = new Date().toUTCString();
      const items = [];

      if (daily && daily.length > 0) {
        // Sort descending by date
        const sorted = [...daily].sort((a, b) => b.date.localeCompare(a.date));

        for (const entry of sorted) {
          const d = new Date(entry.date + 'T12:00:00Z');
          const change = baseline ? (entry.passRate - baseline).toFixed(1) : null;
          const changeStr = change !== null ? ` (${change >= 0 ? '+' : ''}${change}% vs baseline)` : '';
          const title = `Claude Code: ${entry.passRate}% pass rate on ${entry.date}${changeStr}`;
          const desc = [
            `Pass Rate: ${entry.passRate}%`,
            `Confidence Interval: ${entry.ciLower?.toFixed(1)}% - ${entry.ciUpper?.toFixed(1)}%`,
            `Evaluations: ${entry.runsCount}`,
            `Passed: ${entry.passed}`,
            baseline ? `Baseline: ${Math.round(baseline)}%` : '',
            change !== null ? `Change from baseline: ${change >= 0 ? '+' : ''}${change}%` : '',
          ].filter(Boolean).join('\n');

          items.push(`    <item>
      <title>${escapeXML(title)}</title>
      <link>${escapeXML(SOURCE_URL)}</link>
      <guid isPermaLink="false">claude-code-daily-${entry.date}</guid>
      <pubDate>${d.toUTCString()}</pubDate>
      <description>${escapeXML(desc)}</description>
      <category>daily</category>
    </item>`);
        }
      }

      if (weekly && weekly.length > 0) {
        const sorted = [...weekly].sort((a, b) => b.startDate.localeCompare(a.startDate));
        for (const entry of sorted) {
          const d = new Date(entry.endDate + 'T12:00:00Z');
          const title = `Claude Code Weekly: ${entry.passRate}% (${entry.dateRange})`;
          const desc = [
            `Weekly Pass Rate: ${entry.passRate}%`,
            `Period: ${entry.dateRange}`,
            `Confidence Interval: ${entry.ciLower?.toFixed(1)}% - ${entry.ciUpper?.toFixed(1)}%`,
            `Total Evaluations: ${entry.runsCount}`,
          ].filter(Boolean).join('\n');

          items.push(`    <item>
      <title>${escapeXML(title)}</title>
      <link>${escapeXML(SOURCE_URL)}</link>
      <guid isPermaLink="false">claude-code-weekly-${entry.startDate}</guid>
      <pubDate>${d.toUTCString()}</pubDate>
      <description>${escapeXML(desc)}</description>
      <category>weekly</category>
    </item>`);
        }
      }

      return `<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Claude Code Performance Tracker</title>
    <link>${escapeXML(SOURCE_URL)}</link>
    <description>Daily and weekly performance tracking for Claude Code (Opus 4.5) on SWE-Bench Pro tasks, sourced from MarginLab.</description>
    <language>en-us</language>
    <lastBuildDate>${now}</lastBuildDate>
    <generator>claude-perf-tracker RSS generator</generator>
${items.join('\n')}
  </channel>
</rss>`;
    }

    function renderMetrics(data) {
      const el = document.getElementById('metrics');
      const { daily, baseline } = data;
      if (!daily || daily.length === 0) return;

      const sorted = [...daily].sort((a, b) => b.date.localeCompare(a.date));
      const latest = sorted[0];
      const last7 = sorted.slice(0, 7);
      const avg7 = last7.reduce((s, e) => s + e.passRate, 0) / last7.length;
      const avgAll = sorted.reduce((s, e) => s + e.passRate, 0) / sorted.length;

      const changeClass = (val) => val > 0 ? 'change-pos' : val < 0 ? 'change-neg' : 'change-neutral';
      const change30 = baseline ? (avgAll - baseline).toFixed(1) : null;

      el.innerHTML = `
        <div class="metric"><div class="value">${latest.passRate}%</div><div class="label">Latest (${latest.date})</div></div>
        <div class="metric"><div class="value">${avg7.toFixed(1)}%</div><div class="label">7-Day Avg</div></div>
        <div class="metric"><div class="value">${avgAll.toFixed(1)}%</div><div class="label">30-Day Avg</div></div>
        <div class="metric"><div class="value ${baseline ? changeClass(avgAll - baseline) : ''}">${change30 !== null ? (change30 >= 0 ? '+' : '') + change30 + '%' : 'N/A'}</div><div class="label">vs Baseline (${baseline ? Math.round(baseline) : '?'}%)</div></div>
      `;
      el.style.display = '';
    }

    function renderFeedItems(data) {
      const el = document.getElementById('feed-items');
      const { daily, weekly, baseline } = data;
      if (!daily) { el.innerHTML = '<li class="feed-item"><h3>No data found</h3></li>'; return; }

      const sorted = [...daily].sort((a, b) => b.date.localeCompare(a.date));
      let html = '';
      for (const entry of sorted) {
        const change = baseline ? (entry.passRate - baseline).toFixed(1) : null;
        const changeStr = change !== null ? ` <span class="${change >= 0 ? 'change-pos' : 'change-neg'}">(${change >= 0 ? '+' : ''}${change}%)</span>` : '';
        html += `<li class="feed-item">
          <h3>${entry.passRate}% pass rate${changeStr}</h3>
          <div class="date">${entry.date} &middot; ${entry.runsCount} evaluations &middot; ${entry.passed} passed</div>
          <div class="desc">CI: ${entry.ciLower?.toFixed(1)}% – ${entry.ciUpper?.toFixed(1)}%</div>
        </li>`;
      }

      if (weekly && weekly.length > 0) {
        html += '<li class="feed-item" style="border-color:#fb923c;"><h3 style="color:#8b949e;">Weekly Summaries</h3></li>';
        const wsorted = [...weekly].sort((a, b) => b.startDate.localeCompare(a.startDate));
        for (const entry of wsorted) {
          html += `<li class="feed-item">
            <h3>${entry.passRate}% weekly avg</h3>
            <div class="date">${entry.dateRange} &middot; ${entry.runsCount} evaluations</div>
            <div class="desc">CI: ${entry.ciLower?.toFixed(1)}% – ${entry.ciUpper?.toFixed(1)}%</div>
          </li>`;
        }
      }

      el.innerHTML = html;
    }

    async function fetchData() {
      const statusEl = document.getElementById('status');
      statusEl.className = 'status loading';
      statusEl.textContent = 'Fetching latest data from MarginLab...';

      document.getElementById('btn-rss').disabled = true;
      document.getElementById('btn-json').disabled = true;
      document.getElementById('btn-toggle').disabled = true;

      try {
        const html = await fetchWithProxy(SOURCE_URL);
        const data = extractAllData(html);

        if (!data.daily || data.daily.length === 0) {
          throw new Error('Could not extract performance data from page. The page structure may have changed.');
        }

        jsonData = data;
        rssXML = buildRSS(data);

        renderMetrics(data);
        renderFeedItems(data);

        document.getElementById('xml-output').textContent = rssXML;
        document.getElementById('btn-rss').disabled = false;
        document.getElementById('btn-json').disabled = false;
        document.getElementById('btn-toggle').disabled = false;

        statusEl.className = 'status success';
        statusEl.textContent = `Loaded ${data.daily.length} daily entries and ${data.weekly?.length || 0} weekly entries. Last updated: ${new Date().toLocaleString()}`;
      } catch (err) {
        statusEl.className = 'status error';
        statusEl.textContent = `Error: ${err.message}`;
      }
    }

    function downloadRSS() {
      if (!rssXML) return;
      const blob = new Blob([rssXML], { type: 'application/rss+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'claude-code-performance.rss';
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadJSON() {
      if (!jsonData) return;
      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'claude-code-performance.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleXML() {
      const pre = document.getElementById('xml-output');
      pre.classList.toggle('visible');
      document.getElementById('btn-toggle').textContent = pre.classList.contains('visible') ? 'Hide Raw XML' : 'Show Raw XML';
    }

    // Auto-fetch on load
    fetchData();
  </script>
</body>
</html>
